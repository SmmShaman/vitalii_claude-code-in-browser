## Social Media Duplicate Prevention & Instagram Fixes (January 2025)

### –û–ø–∏—Å

–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ –ø–æ—Å—Ç—ñ–≤ –≤ —Å–æ—Ü–º–µ—Ä–µ–∂–∞—Ö —Ç–∞ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è Instagram —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó.

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –î—É–±–ª—ñ–∫–∞—Ç–∏ –ø–æ—Å—Ç—ñ–≤ (Race Condition)

**–°–∏–º–ø—Ç–æ–º–∏:**
- –î–≤–∞ –æ–¥–Ω–∞–∫–æ–≤–∏—Ö –ø–æ—Å—Ç–∏ –≤ Instagram –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ combo button
- "Already posted" –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è —Ö–æ—á–∞ –ø–æ—Å—Ç —â–µ –Ω–µ –ø—É–±–ª—ñ–∫—É–≤–∞–≤—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:**
–§—É–Ω–∫—Ü—ñ—è `wasAlreadyPosted` –ø–µ—Ä–µ–≤—ñ—Ä—è–ª–∞ —Ç—ñ–ª—å–∫–∏ –∑–∞–ø–∏—Å–∏ –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º `'posted'`. –ê–ª–µ –∑–∞–ø–∏—Å —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º `'pending'` **–î–û** —Ñ–∞–∫—Ç–∏—á–Ω–æ—ó –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó:

```
–ó–∞–ø–∏—Ç 1: wasAlreadyPosted() ‚Üí false ‚Üí createSocialPost(pending) ‚Üí –ø—É–±–ª—ñ–∫—É—î–º–æ...
–ó–∞–ø–∏—Ç 2: wasAlreadyPosted() ‚Üí false (–∑–∞–ø–∏—Å 1 —â–µ 'pending'!) ‚Üí createSocialPost(pending) ‚Üí –ø—É–±–ª—ñ–∫—É—î–º–æ...
‚Üí –û–±–∏–¥–≤–∞ –ø–æ—Å—Ç–∏ –ø—É–±–ª—ñ–∫—É—é—Ç—å—Å—è! ‚ùå
```

**–†—ñ—à–µ–Ω–Ω—è:**
–¢–µ–ø–µ—Ä `wasAlreadyPosted` –ø–µ—Ä–µ–≤—ñ—Ä—è—î **—ñ `posted` —ñ `pending`** –∑–∞–ø–∏—Å–∏:

```typescript
// –ë—É–ª–æ
.eq('status', 'posted')

// –°—Ç–∞–ª–æ
.in('status', ['posted', 'pending'])
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: Instagram –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –∫–ª—ñ–∫–∞–±–µ–ª—å–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è

**–§–∞–∫—Ç:** Instagram **–ù–ï –ü–Ü–î–¢–†–ò–ú–£–Ñ** –≥—ñ–ø–µ—Ä–ª—ñ–Ω–∫–∏ –≤ –ø—ñ–¥–ø–∏—Å–∞—Ö –¥–æ –ø–æ—Å—Ç—ñ–≤. –¶–µ –æ–±–º–µ–∂–µ–Ω–Ω—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏ Instagram, –∞ –Ω–µ –±–∞–≥.

**–†—ñ—à–µ–Ω–Ω—è:**
–ó–∞–º—ñ–Ω–µ–Ω–æ –ø–æ–≤–Ω–∏–π URL –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç:

```typescript
// –ë—É–ª–æ
const link = `\n\n${url}`;  // https://vitalii.no/news/long-slug-here

// –°—Ç–∞–ª–æ
const linkText = `\n\nüîó –ß–∏—Ç–∞—Ç–∏ –Ω–∞ vitalii.no`;
```

### –ü—Ä–æ–±–ª–µ–º–∞ 3: Instagram media validation –≤ combo_all_en_no

**–°–∏–º–ø—Ç–æ–º–∏:**
- –ö–Ω–æ–ø–∫–∞ "üåç EN+NO All" –ø–æ–∫–∞–∑—É–≤–∞–ª–∞ –¥–æ–≤–≥—É –ø–æ–º–∏–ª–∫—É –ø—Ä–æ Telegram embed URLs
- Instagram –Ω–µ –ø–µ—Ä–µ–≤—ñ—Ä—è–≤ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –º–µ–¥—ñ–∞ –ø–µ—Ä–µ–¥ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—î—é

**–†—ñ—à–µ–Ω–Ω—è:**
–î–æ–¥–∞–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –º–µ–¥—ñ–∞ –ø–µ—Ä–µ–¥ Instagram –ø—É–±–ª—ñ–∫–∞—Ü—ñ—î—é –≤ combo handler:
- –Ø–∫—â–æ —î Telegram –≤—ñ–¥–µ–æ + GitHub Actions ‚Üí —Ç—Ä–∏–≥–µ—Ä–∏—Ç—å `instagram-video` workflow
- –Ø–∫—â–æ –Ω–µ–º–∞—î –≤–∞–ª—ñ–¥–Ω–æ–≥–æ –º–µ–¥—ñ–∞ ‚Üí –ø–æ–∫–∞–∑—É—î –∫–æ—Ä–æ—Ç–∫–µ "–ù–µ–º–∞—î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è"
- –Ø–∫—â–æ —î –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è/–≤—ñ–¥–µ–æ ‚Üí –ø—É–±–ª—ñ–∫—É—î –Ω–æ—Ä–º–∞–ª—å–Ω–æ

### –ó–º—ñ–Ω–µ–Ω—ñ —Ñ–∞–π–ª–∏

| –§–∞–π–ª | –ó–º—ñ–Ω–∏ |
|------|-------|
| `_shared/social-media-helpers.ts` | `wasAlreadyPosted` –ø–æ–≤–µ—Ä—Ç–∞—î `{ posted, pending, postUrl }` |
| `_shared/facebook-helpers.ts` | `formatInstagramCaption` - –∫–æ—Ä–æ—Ç–∫–∏–π link text |
| `post-to-facebook/index.ts` | –û–±—Ä–æ–±–∫–∞ `pending` —Å—Ç–∞—Ç—É—Å—É |
| `post-to-instagram/index.ts` | –û–±—Ä–æ–±–∫–∞ `pending` —Å—Ç–∞—Ç—É—Å—É |
| `telegram-webhook/index.ts` | Instagram media validation –≤ combo_all_en_no |

### –Ø–∫ –ø—Ä–∞—Ü—é—î –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤

```
1. –ó–∞–ø–∏—Ç –Ω–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—é
2. wasAlreadyPosted() –ø–µ—Ä–µ–≤—ñ—Ä—è—î:
   - status = 'posted' ‚Üí Already posted!
   - status = 'pending' ‚Üí Already in progress!
   - –Ω–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤ ‚Üí –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ
3. createSocialPost(status: 'pending')
4. –ü—É–±–ª—ñ–∫—É—î–º–æ –≤ —Å–æ—Ü–º–µ—Ä–µ–∂—É
5. updateSocialPostSuccess(status: 'posted')
```

–¢–µ–ø–µ—Ä –¥—Ä—É–≥–∏–π –∑–∞–ø–∏—Ç –ø–æ–±–∞—á–∏—Ç—å `pending` –∑–∞–ø–∏—Å —ñ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø—É–±–ª—ñ–∫–∞—Ü—ñ—é.
