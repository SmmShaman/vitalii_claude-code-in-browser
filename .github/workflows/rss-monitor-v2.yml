name: RSS Monitor v2

on:
  schedule:
    # Run every 30 minutes â€” scans ALL sources across 3 batches
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Monitor RSS sources (batch 0 â€” sources 0-9)
        id: batch0
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ðŸ“° RSS Monitor v2 â€” Batch 0"
          echo "Time: $(date -u '+%Y-%m-%d %H:%M UTC')"

          RESULT=$(curl -s -X POST "$SUPABASE_URL/functions/v1/monitor-rss-sources" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -d '{"source": "scheduled", "batchIndex": 0, "batchSize": 10}' \
            --max-time 300)

          echo "Result: $RESULT"
          OK=$(echo "$RESULT" | jq -r '.ok // false')
          SENT=$(echo "$RESULT" | jq -r '.sentToTelegram // 0')
          ANALYZED=$(echo "$RESULT" | jq -r '.articlesAnalyzed // 0')
          echo "analyzed_0=$ANALYZED" >> $GITHUB_OUTPUT
          echo "sent_0=$SENT" >> $GITHUB_OUTPUT

          if [ "$OK" != "true" ]; then
            echo "âš ï¸ Batch 0 had issues but continuing..."
          fi

      - name: Monitor RSS sources (batch 1 â€” sources 10-19)
        id: batch1
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ðŸ“° RSS Monitor v2 â€” Batch 1"

          RESULT=$(curl -s -X POST "$SUPABASE_URL/functions/v1/monitor-rss-sources" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -d '{"source": "scheduled", "batchIndex": 1, "batchSize": 10}' \
            --max-time 300)

          echo "Result: $RESULT"
          OK=$(echo "$RESULT" | jq -r '.ok // false')
          SENT=$(echo "$RESULT" | jq -r '.sentToTelegram // 0')
          ANALYZED=$(echo "$RESULT" | jq -r '.articlesAnalyzed // 0')
          echo "analyzed_1=$ANALYZED" >> $GITHUB_OUTPUT
          echo "sent_1=$SENT" >> $GITHUB_OUTPUT

          if [ "$OK" != "true" ]; then
            echo "âš ï¸ Batch 1 had issues but continuing..."
          fi

      - name: Monitor RSS sources (batch 2 â€” sources 20-29)
        id: batch2
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ðŸ“° RSS Monitor v2 â€” Batch 2"

          RESULT=$(curl -s -X POST "$SUPABASE_URL/functions/v1/monitor-rss-sources" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -d '{"source": "scheduled", "batchIndex": 2, "batchSize": 10}' \
            --max-time 300)

          echo "Result: $RESULT"
          OK=$(echo "$RESULT" | jq -r '.ok // false')
          SENT=$(echo "$RESULT" | jq -r '.sentToTelegram // 0')
          ANALYZED=$(echo "$RESULT" | jq -r '.articlesAnalyzed // 0')
          echo "analyzed_2=$ANALYZED" >> $GITHUB_OUTPUT
          echo "sent_2=$SENT" >> $GITHUB_OUTPUT

          if [ "$OK" != "true" ]; then
            echo "âš ï¸ Batch 2 had issues but continuing..."
          fi

      - name: Summary
        if: always()
        run: |
          echo "## RSS Monitor v2 Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Batch 0:** analyzed=${{ steps.batch0.outputs.analyzed_0 || 'N/A' }}, sent=${{ steps.batch0.outputs.sent_0 || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Batch 1:** analyzed=${{ steps.batch1.outputs.analyzed_1 || 'N/A' }}, sent=${{ steps.batch1.outputs.sent_1 || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Batch 2:** analyzed=${{ steps.batch2.outputs.analyzed_2 || 'N/A' }}, sent=${{ steps.batch2.outputs.sent_2 || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
