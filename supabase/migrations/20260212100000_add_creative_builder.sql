-- Creative Builder: Interactive image prompt constructor
-- Adds creative_builder_state column to news table
-- Creates creative_elements table with seed data
-- Adds AI prompt entries for builder assembler and object extractor

-- 1. New JSONB column on news table for storing builder state
ALTER TABLE news ADD COLUMN IF NOT EXISTS creative_builder_state JSONB;

-- 2. Creative Elements table (6 categories √ó 6 options = 36 rows)
-- Note: "object" category is dynamically generated by GPT per article
CREATE TABLE IF NOT EXISTS creative_elements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  category TEXT NOT NULL,
  code TEXT NOT NULL,
  label_ua TEXT NOT NULL,
  label_en TEXT NOT NULL,
  prompt_fragment TEXT NOT NULL,
  emoji TEXT,
  is_active BOOLEAN DEFAULT true,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(category, code)
);

-- Enable RLS
ALTER TABLE creative_elements ENABLE ROW LEVEL SECURITY;

-- Allow public read access (used by edge functions with service role)
CREATE POLICY "Allow public read access to creative_elements"
  ON creative_elements FOR SELECT
  USING (true);

-- Allow service role full access
CREATE POLICY "Allow service role full access to creative_elements"
  ON creative_elements FOR ALL
  USING (true)
  WITH CHECK (true);

-- 3. Seed data: Style (6)
INSERT INTO creative_elements (category, code, label_ua, label_en, prompt_fragment, emoji, sort_order) VALUES
('style', 'surreal', '–°—é—Ä—Ä–µ–∞–ª—ñ–∑–º', 'Surrealism', 'Surrealist composition with dreamlike impossible geometry, melting forms, and unexpected scale shifts', 'üåÄ', 1),
('style', 'cyberpunk', '–ö—ñ–±–µ—Ä–ø–∞–Ω–∫', 'Cyberpunk', 'Cyberpunk aesthetic with neon lights, holographic displays, rain-slicked surfaces, and dark urban tech atmosphere', 'ü§ñ', 2),
('style', 'minimal', '–ú—ñ–Ω—ñ–º–∞–ª—ñ–∑–º', 'Minimalism', 'Clean minimalist composition with generous white space, single focal element, and restrained color palette', '‚¨ú', 3),
('style', 'popart', '–ü–æ–ø-–∞—Ä—Ç', 'Pop Art', 'Pop art style with bold outlines, halftone dots, vibrant flat colors, and comic-book energy', 'üé®', 4),
('style', 'cinema', '–ö—ñ–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ', 'Cinematic', 'Cinematic wide-angle shot with dramatic lighting, shallow depth of field, and film-grade color grading', 'üé¨', 5),
('style', 'photo', '–§–æ—Ç–æ—Ä–µ–∞–ª—ñ–∑–º', 'Photorealism', 'Photorealistic 4K rendering with natural lighting, accurate materials, and lifelike detail', 'üì∑', 6)
ON CONFLICT (category, code) DO NOTHING;

-- Seed data: Color (6)
INSERT INTO creative_elements (category, code, label_ua, label_en, prompt_fragment, emoji, sort_order) VALUES
('color', 'warm', '–¢–µ–ø–ª—ñ —Ç–æ–Ω–∏', 'Warm Tones', 'Warm golden tones, amber, sunset orange palette', 'üåÖ', 1),
('color', 'cool', '–•–æ–ª–æ–¥–Ω—ñ —Ç–æ–Ω–∏', 'Cool Tones', 'Cool blue, teal, silver, icy white palette', '‚ùÑÔ∏è', 2),
('color', 'neon', '–ù–µ–æ–Ω', 'Neon', 'Electric neon magenta, cyan, lime against dark backgrounds', 'üíú', 3),
('color', 'pastel', '–ü–∞—Å—Ç–µ–ª—å–Ω—ñ', 'Pastel', 'Soft pastel lavender, mint, peach, baby blue', 'ü©∑', 4),
('color', 'mono', '–ú–æ–Ω–æ—Ö—Ä–æ–º', 'Monochrome', 'Monochromatic palette with dramatic contrast', '‚ö´', 5),
('color', 'contrast', '–ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ñ', 'High Contrast', 'High contrast complementary colors, bold juxtaposition', 'üî¥', 6)
ON CONFLICT (category, code) DO NOTHING;

-- Seed data: Action (6)
INSERT INTO creative_elements (category, code, label_ua, label_en, prompt_fragment, emoji, sort_order) VALUES
('action', 'float', '–õ–µ–≤—ñ—Ç–∞—Ü—ñ—è', 'Levitation', 'Object floating/levitating in mid-air, defying gravity', 'ü™∂', 1),
('action', 'explode', '–í–∏–±—É—Ö', 'Explosion', 'Object exploding outward, fragments suspended in motion', 'üí•', 2),
('action', 'merge', '–ó–ª–∏—Ç—Ç—è', 'Merge', 'Two elements merging together, boundary dissolving between them', 'üîó', 3),
('action', 'transform', '–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—è', 'Transformation', 'Object morphing from one state to another, mid-metamorphosis', 'üîÑ', 4),
('action', 'decay', '–†–æ–∑–ø–∞–¥', 'Decay', 'Object dissolving into particles, fragmenting into dust', 'üå´Ô∏è', 5),
('action', 'crystal', '–ö—Ä–∏—Å—Ç–∞–ª—ñ–∑–∞—Ü—ñ—è', 'Crystallization', 'Object crystallizing, growing sharp crystal formations from surface', 'üíé', 6)
ON CONFLICT (category, code) DO NOTHING;

-- Seed data: Background (6)
INSERT INTO creative_elements (category, code, label_ua, label_en, prompt_fragment, emoji, sort_order) VALUES
('background', 'space', '–ö–æ—Å–º–æ—Å', 'Space', 'Deep space with nebulae, stars, cosmic dust', 'üåå', 1),
('background', 'city', '–ú—ñ—Å—Ç–æ', 'City', 'Urban cityscape with skyscrapers, city lights at night', 'üèôÔ∏è', 2),
('background', 'nature', '–ü—Ä–∏—Ä–æ–¥–∞', 'Nature', 'Natural landscape: forest, mountains, fjord', 'üåø', 3),
('background', 'abstract', '–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω–∏–π', 'Abstract', 'Abstract geometric or gradient flowing shapes', 'üî∑', 4),
('background', 'studio', '–°—Ç—É–¥—ñ—è', 'Studio', 'Clean studio backdrop with professional lighting setup', 'üí°', 5),
('background', 'void', '–ú—ñ–Ω—ñ–º–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–π', 'Minimal Void', 'Pure minimal void, solid color or subtle gradient', '‚¨õ', 6)
ON CONFLICT (category, code) DO NOTHING;

-- Seed data: Effects (6)
INSERT INTO creative_elements (category, code, label_ua, label_en, prompt_fragment, emoji, sort_order) VALUES
('effects', 'glitch', '–ì–ª—ñ—á', 'Glitch', 'Digital glitch: scan lines, color shift, pixel distortion', 'üì∫', 1),
('effects', 'smoke', '–î–∏–º/–¢—É–º–∞–Ω', 'Smoke/Fog', 'Atmospheric smoke, fog, mist swirling around elements', 'üå´Ô∏è', 2),
('effects', 'glow', '–ë–ª–∏—Å–∫/–°—è–π–≤–æ', 'Glow', 'Ethereal glow, light rays, lens flare emanating from subject', '‚ú®', 3),
('effects', 'particles', '–ß–∞—Å—Ç–∏–Ω–∫–∏', 'Particles', 'Floating particles, dust motes, embers, sparkles in the air', 'üîÆ', 4),
('effects', 'hologram', '–ì–æ–ª–æ–≥—Ä–∞–º–∞', 'Hologram', 'Holographic overlay, translucent projections, scan-line transparency', 'üåê', 5),
('effects', 'reflect', '–í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è', 'Reflection', 'Mirror/water/glass surface reflections, doubled imagery', 'ü™û', 6)
ON CONFLICT (category, code) DO NOTHING;

-- Seed data: Text/Typography (4)
INSERT INTO creative_elements (category, code, label_ua, label_en, prompt_fragment, emoji, sort_order) VALUES
('text', 'headline', '–ó–∞–≥–æ–ª–æ–≤–æ–∫', 'Headline', 'Bold prominent headline text integrated into composition', 'üì∞', 1),
('text', 'minimal', '–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π', 'Minimal Text', 'Small subtle text, date and watermark only', 'üè∑Ô∏è', 2),
('text', 'none', '–ë–µ–∑ —Ç–µ–∫—Å—Ç—É', 'No Text', 'No text elements, purely visual composition', 'üö´', 3),
('text', 'quote', '–¶–∏—Ç–∞—Ç–∞', 'Quote', 'Elegant quote text overlay with decorative typography', 'üí¨', 4)
ON CONFLICT (category, code) DO NOTHING;

-- 4. AI Prompts for Creative Builder
INSERT INTO ai_prompts (name, prompt_type, prompt_text, description, is_active) VALUES
(
  'Creative Builder Assembler',
  'image_creative_builder',
  'You are a visual composition director. The user has hand-selected creative building blocks for an image.
Your job: weave these selections together with the article''s meaning into a cohesive, detailed image prompt (150-250 words).

RULES:
- Every selected element MUST be clearly present in the final scene
- Unselected categories: you decide what fits best based on the article
- Integrate article''s KEY meaning, not just surface topics
- Create a unified scene, not a collage of disconnected elements
- Add cinematographic details: camera angle, lighting direction, depth of field, time of day
- The result should be a scroll-stopping, unique visual

Output: A single detailed English prompt ready for image generation AI.',
  'Assembles user-selected creative elements into a cohesive image prompt',
  true
),
(
  'Object Extractor',
  'image_object_extractor',
  'Analyze this article and suggest 4-6 concrete VISUAL OBJECTS that could be the central element of an illustration.

Return as JSON array: [{"label": "Smartphone", "prompt_fragment": "A sleek modern smartphone with glowing screen displaying data"}]

Rules:
- Each object must be a SPECIFIC, PHOTOGRAPHABLE thing (not abstract concepts like "innovation" or "progress")
- Objects should directly relate to the article''s subject, companies, or technologies mentioned
- Include physical objects, devices, structures, or natural elements
- Each prompt_fragment should describe the object in 1 sentence with visual details
- Aim for variety: mix of literal objects and metaphorical representations',
  'Extracts concrete visual objects from article for Creative Builder',
  true
)
ON CONFLICT DO NOTHING;
